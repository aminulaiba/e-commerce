{% extends 'store/base.html' %}

{% block content %}
<div id="place-order-view" class="hidden mx-auto max-h-full px-4 py-10 grid grid-cols-1 lg:grid-cols-3 gap-8">


  <!-- LEFT: Checkout Form -->
  <div class="lg:col-span-2">
    <h1 class="text-2xl font-bold mb-6">Checkout</h1>

    <!-- Saved Addresses -->
    {% if request.user.is_authenticated %}
      <div>
        <label class="block font-semibold mb-1">Select Saved Address</label>
        <select id="saved-addresses" class="w-full border rounded px-4 py-2">
          <option value="">-- Select a saved address --</option>
          {% for address in saved_addresses %}
            <option 
              value="{{ address.id }}"
              data-full-name="{{ address.full_name }}"
              data-phone="{{ address.phone }}"
              data-address="{{ address.address_line_1 }}"
            >
              {{ address.full_name }} - {{ address.address_line_1|truncatechars:40 }}
            </option>
          {% endfor %}
        </select>
      </div>
    {% endif %}


    <form method="POST" action="" class="bg-white shadow-md rounded-lg p-6 space-y-4">
      {% csrf_token %}

      <div>
        <label class="block font-semibold mb-1">Full Name</label>
        <input type="text" name="full_name" required class="w-full border rounded px-4 py-2">
      </div>

      <div>
        <label class="block font-semibold mb-1">Phone Number</label>
        <input type="text" name="phone" required class="w-full border rounded px-4 py-2">
      </div>

      <div>
        <label class="block font-semibold mb-1">Shipping Address</label>
        <textarea name="address" rows="3" required class="w-full border rounded px-4 py-2"></textarea>
      </div>

      <div>
        <label class="block font-semibold mb-1">Payment Method</label>
        <select name="payment_method" id="payment-method" class="w-full border rounded px-4 py-2">
          <option value="cod">Cash on Delivery</option>
          <option value="bkash">bKash</option>
          <option value="card">Credit/Debit Card</option>
        </select>
      </div>

      <!-- Conditional Inputs -->
      <div id="bkash-number-field" class="hidden">
        <label class="block font-semibold mb-1">bKash Number</label>
        <input type="text" name="bkash_number" placeholder="01XXXXXXXXX" class="w-full border rounded px-4 py-2">
      </div>

      <div id="card-number-field" class="hidden">
        <label class="block font-semibold mb-1">Card Number</label>
        <input type="text" name="card_number" placeholder="**** **** **** ****" class="w-full border rounded px-4 py-2">
      </div>

      <button type="submit" class="w-full mt-4 bg-green-600 hover:bg-green-700 text-white py-3 rounded-lg font-semibold transition">
        Place Order
      </button>
    </form>
  </div>

  <!-- RIGHT: Cart Sidebar -->
  <div class="bg-white shadow-md rounded-lg p-6 sticky top-10 h-fit">
    <h2 class="text-xl font-bold mb-4">Order Summary</h2>

    <!-- Product List -->
    <div class="space-y-4 max-h-[400px] overflow-y-auto pr-2">
      {% for item in cart_products %}
        <div class="flex items-center gap-4 border-b pb-3">
          <img src="{{ item.product.image.url }}" alt="Product" class="w-14 h-14 object-cover rounded">
          <div class="flex-1">
            <h3 class="text-sm font-semibold">{{ item.product.name }}</h3>
            <p class="text-xs text-gray-500">Qty: {{ item.quantity }}</p>
          </div>
          <div class="text-sm font-semibold text-gray-800">
            {% if item.product.on_sale %}
              {{ item.product.sale_price }}
            {% else %}
              {{ item.product.price }}
            {% endif %}
            <span class="text-xs text-gray-400">tk</span>
          </div>
        </div>
      {% endfor %}
    </div>

    <!-- Summary -->
    <div class="mt-6 pt-4 border-t text-sm">
      <div class="flex justify-between mb-2">
        <span class="text-gray-700">Subtotal</span>
        <span>{{ subtotal }} tk</span>
      </div>
      <div class="flex justify-between mb-2">
        <span class="text-gray-700">Shipping</span>
        <span>{{ shipping }} tk</span>
      </div>
      <div class="flex justify-between font-bold text-base border-t pt-2">
        <span>Total</span>
        <span>{{ total }} tk</span>
      </div>
    </div>
  </div>

</div>


<div id="checkout-view" class="max-w-4xl mx-auto px-4 py-10">
    <h1 class="text-3xl font-bold mb-6">Your Shopping Cart</h1>
    <!-- Cart Item -->
        {% for item in cart_products %}

        <div id="" class="product-container bg-white rounded-lg shadow-md p-6 mb-4 flex items-center justify-between">
            <div class="flex items-center gap-4">
                <img src="{{ item.product.image.url }}" alt="Product" class="w-20 h-20 object-cover rounded">
                <div>
                    <h2 class="text-lg font-semibold">{{item.product.name}}</h2>
                    <p class="text-sm text-gray-600">{{item.product.description}}</p>
                </div>
            </div>
            <div class="text-right">
                <p class="text-lg font-bold">
                    {% if item.product.on_sale %}
                        {{ item.product.sale_price }}
                    {% else %}
                        {{ item.product.price }}
                    {% endif %}
                </p>

                <p class="sub-total font-semibold mt-1">
                    
                </p>

                <input type="number" min="1" value="{{ item.quantity }}" data-prod-id="{{ item.product.id }}" class="updatebtn w-16 border rounded text-center mt-2 px-2 py-1">
                <button type="button" data-prod-id="{{ item.product.id }}" title="Remove from cart" class="delBtn bg-red-500 hover:bg-red-800 text-white rounded p-1 transition">üóëÔ∏è</button>
            </div>
        </div>

        {% endfor %}

    <!-- Repeat above block for each item (you'll loop in Django) -->

    <!-- Cart Summary -->
    <div class="bg-white rounded-lg shadow-md p-6 mt-6">
        <div class="flex justify-between mb-2">
            <span class="text-gray-700">Subtotal</span>
            <span id="sub-total" class="font-semibold">{{ subtotal }} tk</span>
        </div>
        <div class="flex justify-between mb-2">
            <span class="text-gray-700">Shipping</span>
            <span id="shipping" class="font-semibold">{{shipping}} tk</span>
        </div>
        <div class="flex justify-between text-xl font-bold border-t pt-4">
            <span>Total</span>
            <span id="total">{{total}} tk</span>
        </div>

        <button id="checkout-btn" class="mt-6 w-full bg-blue-600 hover:bg-blue-700 text-white py-3 px-6 rounded-lg font-semibold transition">
            Proceed to Checkout
        </button>
    </div>
</div>




<!-- Script: Slide transition + Payment Method toggle -->
<script>
  document.addEventListener('DOMContentLoaded', function () {
    // toggle between checkout view and place order view
    const checkoutDiv = document.getElementById('checkout-view');
    const placeOrderView = document.getElementById('place-order-view');
    const checkoutBtn = document.getElementById('checkout-btn');

    checkoutBtn.addEventListener('click', () => {
      checkoutDiv.classList.add('hidden');
      placeOrderView.classList.remove('hidden')
    });

    // Payment Method Toggle
    const paymentSelect = document.getElementById('payment-method');
    const bkashField = document.getElementById('bkash-number-field');
    const cardField = document.getElementById('card-number-field');

    function togglePaymentFields() {
      const method = paymentSelect.value;
      bkashField.classList.add('hidden');
      cardField.classList.add('hidden');

      if (method === 'bkash') {
        bkashField.classList.remove('hidden');
      } else if (method === 'card') {
        cardField.classList.remove('hidden');
      }
    }

    paymentSelect.addEventListener('change', togglePaymentFields);
    togglePaymentFields(); // run on load


    // fill addr from selecting saved addr
    document.getElementById('saved-addresses').addEventListener('change', function () {
    const selectedOption = this.options[this.selectedIndex];
    
    const fullName = selectedOption.getAttribute('data-full-name');
    const phone = selectedOption.getAttribute('data-phone');
    const address = selectedOption.getAttribute('data-address');

    if (fullName && phone && address) {
      document.querySelector('input[name="full_name"]').value = fullName;
      document.querySelector('input[name="phone"]').value = phone;
      document.querySelector('textarea[name="address"]').value = address;
    }
  });
  });
</script>



<script>
    document.addEventListener('DOMContentLoaded', function(){
        const subtotal = document.getElementById('sub-total');
        const shipping = document.getElementById('shipping');
        const total = document.getElementById('total');
        // Function to extract numeric value from text like "27000.0 tk"
        function extractNumber(text) {
            return parseFloat(text.replace(/[^\d.]/g, ""));
        }

        const updatebtn = document.querySelectorAll('.updatebtn')
        let updvalue;
        let debounceTimeout;
        updatebtn.forEach(input=>{
            input.addEventListener('input', function(){
                updvalue = this.value;
                prodId = this.dataset.prodId
                clearTimeout(debounceTimeout);
                debounceTimeout = setTimeout(() => {
                    fetch("{% url 'cart-update' %}", {
                        method: "POST",
                        headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify({prodId: prodId, updval: updvalue})
                    })
                    .then(res=> res.json())
                    .then(data => {
                    document.getElementById('count').innerText= data.cart;
                    subtotal.innerText = data.total+" tk";
                    shipping_cost= extractNumber(shipping.textContent)
                    total.innerText = Number(data.total)+Number(shipping_cost)+" tk";
                });
                    
                }, 1000);
            })
        })


        // deleting cart
        const delBtn = document.querySelectorAll('.delBtn');
        delBtn.forEach(delBtn => {
            delBtn.addEventListener('click', function(){
                prodId = this.dataset.prodId
                prodContainer = this.closest('.product-container')

                fetch("{% url 'cart-delete' %}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({prodId: prodId})
                }).then(res => res.json())
                .then(data => {
                    document.getElementById('count').innerText= data.cart;
                    prodContainer.remove();
                    subtotal.innerText = data.total+" tk";
                    shipping_cost= Number(data.total) === 0 ? (shipping.innerText = "0 tk", 0) : extractNumber(shipping.textContent)
                    total.innerText = Number(data.total)+Number(shipping_cost)+" tk";
                });

                
            })
        })

    })
</script>


{% endblock %}
