{% extends 'store/base.html' %}

{% block extra_head %}
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Set default font to Inter and a nice smooth background */
        @import url('https://fonts.fonts.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f9;
        }
        /* Custom styles for the stepper (enhanced visibility/transition) */
        .step-number {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 2px solid #e5e7eb; /* default border-gray-200 */
            color: #1f2937; /* default text-gray-800 */
            background-color: white;
            transition: all 0.3s ease;
            font-weight: 600;
        }
        .step-active .step-number {
            border-color: #1f2937;
            background-color: #1f2937;
            color: white;
            transform: scale(1.05);
        }
        .step-complete .step-number {
            border-color: #1f2937;
            background-color: #1f2937;
            color: white;
        }
        .step-complete .step-number svg {
            display: block;
        }
        .step-complete .step-text,
        .step-active .step-text {
            font-weight: 700;
            color: #1f2937;
        }
        .step-complete .step-number span,
        .step-active .step-number span {
            display: none;
        }
        .step-line-active {
             background-color: #1f2937;
        }
    </style>
{% endblock %}

{% block content %}

<div class="p-4 sm:p-8 md:p-12 min-h-screen">
  <div class="max-w-6xl mx-auto">
      <!-- Main Title -->
      <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-900 text-center mb-10">
          <span id="main-title">Your Shopping Cart</span>
      </h1>

      <!-- Stepper (Progress Bar) -->
      <div id="stepper" class="flex justify-center items-center mb-12 sm:mb-16">
          <!-- Step 1: Shopping cart -->
          <div id="step-1" class="step-item step-active flex flex-col items-center cursor-pointer transition duration-300" onclick="goToStep(1)">
              <div class="step-number relative">
                  <span>1</span>
                  <i data-lucide="check" class="w-5 h-5 hidden"></i>
              </div>
              <div class="step-text mt-2 text-sm text-center text-gray-900 transition duration-300">Shopping Cart</div>
          </div>
          <div id="line-1-2" class="flex-1 h-0.5 bg-gray-300 mx-2 transition-colors duration-300 w-16"></div>

          <!-- Step 2: Checkout details -->
          <div id="step-2" class="step-item flex flex-col items-center text-gray-400 cursor-pointer transition duration-300" onclick="goToStep(2)">
              <div class="step-number">
                  <span>2</span>
                  <i data-lucide="check" class="w-5 h-5 hidden"></i>
              </div>
              <div class="step-text mt-2 text-sm text-center">Checkout Details</div>
          </div>
          <div id="line-2-3" class="flex-1 h-0.5 bg-gray-300 mx-2 transition-colors duration-300 w-16"></div>

          <!-- Step 3: Order complete -->
          <div id="step-3" class="step-item flex flex-col items-center text-gray-400 cursor-default transition duration-300">
              <div class="step-number">
                  <span>3</span>
                  <i data-lucide="check" class="w-5 h-5 hidden"></i>
              </div>
              <div class="step-text mt-2 text-sm text-center">Order Complete</div>
          </div>
      </div>

      <!-- PAGE CONTENT CONTAINER -->
      <div id="page-content-container" class="mt-8">

          <!-- ============================================== -->
          <!-- STEP 1 CONTENT: SHOPPING CART -->
          <!-- ============================================== -->
          <div id="step-1-content" class="page-content" style="display: none;">
              <h2 class="text-2xl font-bold mb-6 text-gray-900">Review Your Items</h2>
              
              <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                  <!-- Cart Items List (2/3 width on desktop) -->
                  <div class="lg:col-span-2 space-y-4">
                      <div class="flex justify-between items-center mb-4 pb-2 border-b border-gray-200">
                          <label class="flex items-center space-x-2 text-sm font-medium text-gray-700">
                              <input type="checkbox" id="select-all" class="h-4 w-4 rounded border-gray-300 text-gray-900 focus:ring-0 focus:ring-offset-0">
                              <span>Select All</span>
                          </label>
                          <button class="flex items-center px-4 py-2 bg-red-500 text-white text-sm font-medium rounded-xl shadow-lg hover:bg-red-600 transition duration-150">
                              <i data-lucide="trash-2" class="w-4 h-4 mr-2"></i>
                              Delete Selected
                          </button>
                      </div>
                      
                      <!--  Card Items -->
                      {% for item in cart_products %}
                      <div class="cart-item product-container flex flex-col sm:flex-row items-start sm:items-center p-4 bg-white rounded-2xl shadow-lg transition hover:shadow-xl">
                          <input type="checkbox" class="h-5 w-5 mt-1 sm:mt-0 mr-4 rounded border-gray-300 text-gray-900 focus:ring-0 flex-shrink-0">
                          <!-- Placeholder Image (Mobile-friendly) -->
                          <div class="w-20 h-20 bg-gray-100 rounded-xl overflow-hidden mr-4 flex-shrink-0 relative hidden sm:block">
                              <img src="{{ item.product.image.url }}" alt="Product">
                          </div>
                          
                          <div class="flex-grow flex flex-col sm:flex-row justify-between w-full">
                              <div class="mb-2 sm:mb-0">
                                  <p class="text-lg font-semibold text-gray-900">{{ item.product.name }}</p>
                                  <p class="text-xl font-bold mt-1 text-gray-900">
                                    {% if item.product.on_sale %}
                                      {{ item.product.sale_price }}
                                    {% else %}
                                      {{ item.product.price }}
                                    {% endif %}
                                    <span class="text-xs text-gray-400">tk</span>
                                  </p>
                              </div>
                              
                              <div class="">
                                  <input type="number" min="1" value="{{ item.quantity }}" data-prod-id="{{ item.product.id }}" class="updatebtn w-16 border rounded text-center mt-2 px-2 py-1">
                                  <button type="button" data-prod-id="{{ item.product.id }}" title="Remove from cart" class="delBtn bg-red-500 hover:bg-red-800 text-white rounded p-1 transition">üóëÔ∏è</button>
                              </div>
                          </div>
                      </div>
                      {% endfor %}
                  </div>

                  <!-- Order Summary Card (1/3 width on desktop) -->
                  <div class="lg:col-span-1 p-6 bg-white rounded-2xl shadow-xl h-fit sticky top-4">
                      <h3 class="text-2xl font-bold mb-6">Order Summary</h3>
                      
                      <!-- Coupon Code Input -->
                      <div class="flex items-center mb-6 border-b border-gray-100 pb-4">
                          <i data-lucide="ticket" class="w-5 h-5 text-gray-500 mr-3 flex-shrink-0"></i>
                          <input type="text" placeholder="Promo Code" class="flex-grow p-2 text-sm border border-gray-200 rounded-lg focus:ring-black focus:border-black placeholder-gray-400 mr-2">
                          <button class="px-5 py-2 bg-gray-900 text-white text-sm font-medium rounded-xl hover:bg-gray-700 transition duration-150">
                              Apply
                          </button>
                      </div>
                      
                      <div class="space-y-3 mb-6">
                          <div class="flex justify-between text-gray-700">
                              <span class="text-base">Subtotal (6 Items)</span>
                              <span id="sub-total" class="font-semibold">{{ subtotal }} tk</span>
                          </div>
                          <div class="flex justify-between text-green-600">
                              <span class="text-base">Discount (Promo)</span>
                              <span class="font-semibold">-$coming</span>
                          </div>
                          <div class="flex justify-between text-gray-700">
                              <span class="text-base">Shipping & Handling</span>
                              <span id="shipping" class="font-semibold">{{ shipping }} tk</span>
                          </div>
                      </div>
                      
                      <div class="flex justify-between pt-4 border-t border-gray-200">
                          <span class="text-xl font-bold">Total</span>
                          <span id="total" class="text-3xl font-extrabold text-gray-900">{{ total }} tk</span>
                      </div>

                      <button onclick="nextStep()" class="mt-6 w-full flex items-center justify-center px-6 py-4 bg-black text-white text-lg font-semibold rounded-xl shadow-2xl shadow-black/20 hover:bg-gray-800 transition duration-150 transform hover:scale-[1.01]">
                          Proceed to Checkout 
                          <i data-lucide="arrow-right" class="w-5 h-5 ml-2"></i>
                      </button>
                  </div>
              </div>
          </div>

          <!-- ============================================== -->
          <!-- STEP 2 CONTENT: CHECKOUT DETAILS (SHIPPING/PAYMENT) -->
          <!-- ============================================== -->
          <div id="step-2-content" class="page-content max-w-3xl mx-auto" style="display: none;">
            <h2 class="text-2xl font-bold mb-8 text-center text-gray-900">Secure Checkout</h2>
            
            <div class="bg-white p-6 sm:p-8 rounded-2xl shadow-xl space-y-8">
                {% if request.user.is_authenticated %}
                    <!-- Saved address Section -->
                    <div class="border-b pb-6 border-gray-100">
                        <h3 class="text-xl font-semibold mb-4 flex items-center text-gray-800">
                            <i data-lucide="truck" class="w-6 h-6 mr-3 text-green-500"></i>
                            Saved Addresses
                        </h3>
                        <div class="space-y-3">
                            {% for adrs in saved_addresses %}
                                <label class="flex items-center p-4 bg-gray-50 border-2 border-transparent rounded-xl cursor-pointer hover:border-gray-300 transition duration-150 has-[:checked]:border-indigo-500">
                                    <input type="radio" name="shipping_address" value="{{ adrs.id }}" {% if adrs.is_default %} checked {% endif %} class="h-5 w-5 text-indigo-600 focus:ring-indigo-500 border-gray-300">
                                    <span class="ml-4 font-medium text-gray-900 flex-grow">{{ adrs }}</span>
                                    <i data-lucide="map-pin-house" class="w-6 h-6 text-gray-500"></i>
                                </label>
                            {% endfor %}
                            <div>
                                <a href="{% url 'shippingaddress-add' %}">
                                    <div class="flex items-center justify-center p-4 bg-gray-50 border-2 border-transparent rounded-xl cursor-pointer hover:border-gray-300 transition duration-150 has-[:checked]:border-indigo-500">
                                        <i data-lucide="circle-plus" class="w-6 h-6 text-gray-500"></i>
                                    </div>
                                </a>
                            </div>
                        </div>
                    </div>
                {% else %}
                    <!-- Shipping Address Section -->
                    <div class="border-b pb-6 border-gray-100">
                        <h3 class="text-xl font-semibold mb-4 flex items-center text-gray-800">
                            <i data-lucide="package" class="w-6 h-6 mr-3 text-indigo-500"></i>
                            Delivery Information
                        </h3>
                        <form class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <input type="text" placeholder="First Name" class="col-span-1 p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" required>
                            <input type="text" placeholder="Last Name" class="col-span-1 p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" required>
                            <input type="text" placeholder="Address Line 1" class="col-span-2 p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" required>
                            <input type="text" placeholder="City" class="col-span-1 p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" required>
                            <input type="text" placeholder="Zip/Postal Code" class="col-span-1 p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" required>
                            <input type="email" placeholder="Email Address" class="col-span-2 p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" required>
                        </form>
                    </div>
                {% endif %}
                    <!-- Payment Method Section -->
                    <div>
                        <h3 class="text-xl font-semibold mb-4 flex items-center text-gray-800">
                            <i data-lucide="credit-card" class="w-6 h-6 mr-3 text-green-500"></i>
                            Payment Details
                        </h3>
                        <div class="space-y-3">
                            <label class="flex items-center p-4 bg-gray-50 border-2 border-transparent rounded-xl cursor-pointer hover:border-gray-300 transition duration-150 has-[:checked]:border-indigo-500">
                                <input type="radio" name="payment" value="card" checked class="h-5 w-5 text-indigo-600 focus:ring-indigo-500 border-gray-300">
                                <span class="ml-4 font-medium text-gray-900 flex-grow">Credit Card (Visa/Mastercard)</span>
                                <i data-lucide="square-mouse-pointer" class="w-6 h-6 text-gray-500"></i>
                            </label>
                            <label class="flex items-center p-4 bg-gray-50 border-2 border-transparent rounded-xl cursor-pointer hover:border-gray-300 transition duration-150 has-[:checked]:border-indigo-500">
                                <input type="radio" name="payment" value="paypal" class="h-5 w-5 text-indigo-600 focus:ring-indigo-500 border-gray-300">
                                <span class="ml-4 font-medium text-gray-900 flex-grow">PayPal / Digital Wallet</span>
                                <i data-lucide="wallet" class="w-6 h-6 text-gray-500"></i>
                            </label>
                        </div>
                    </div>

                <!-- Final Action Buttons -->
                <div class="flex flex-col sm:flex-row justify-between gap-4 pt-4 border-t border-gray-200">
                    <button onclick="goToStep(1)" class="w-full sm:w-1/3 flex items-center justify-center px-6 py-3 bg-gray-100 text-gray-800 text-base font-medium rounded-xl hover:bg-gray-200 transition duration-150">
                        <i data-lucide="arrow-left" class="w-5 h-5 mr-2"></i>
                        Back to Cart
                    </button>
                    <button onclick="nextStep()" class="w-full sm:w-2/3 flex items-center justify-center px-6 py-3 bg-black text-white text-lg font-semibold rounded-xl shadow-2xl shadow-black/20 hover:bg-gray-800 transition duration-150 transform hover:scale-[1.01]">
                        Confirm & Pay ({{ total }}‡ß≥)
                    </button>
                </div>
            </div>
        </div>

          <!-- ============================================== -->
          <!-- STEP 3 CONTENT: ORDER COMPLETE -->
          <!-- ============================================== -->
          <div id="step-3-content" class="page-content max-w-xl mx-auto text-center" style="display: none;">
              <div class="p-8 sm:p-12 bg-white rounded-3xl shadow-2xl border-t-4 border-green-500">
                  <div class="mx-auto w-24 h-24 bg-green-500 rounded-full flex items-center justify-center mb-6 animate-pulse">
                      <i data-lucide="thumbs-up" class="w-14 h-14 text-white" stroke-width="2.5"></i>
                  </div>
                  <h2 class="text-3xl font-extrabold text-gray-900 mb-4">Success! Order Placed.</h2>
                  <p class="text-lg text-gray-600 mb-6">Your order has been successfully confirmed. A detailed receipt and shipping updates will be sent shortly.</p>
                  
                  <div class="space-y-3 mb-8 p-4 bg-green-50 rounded-xl border border-green-200">
                      <div class="flex justify-between font-medium text-gray-800">
                          <span>Order ID:</span>
                          <span class="font-mono bg-white px-2 py-0.5 rounded-md text-sm shadow-inner">XYZ-456-7890</span>
                      </div>
                      <div class="flex justify-between font-medium text-gray-800">
                          <span>Total Charged:</span>
                          <span class="text-green-600 font-extrabold text-xl">{{ total }}‡ß≥</span>
                      </div>
                      <div class="flex justify-between font-medium text-gray-800">
                          <span>Delivery Estimate:</span>
                          <span class="text-gray-900">4-7 Business Days</span>
                      </div>
                  </div>

                  <div class="flex flex-col sm:flex-row gap-4 justify-center">
                        <a href="#" class="w-full sm:w-auto flex items-center justify-center px-6 py-3 border border-gray-300 text-gray-800 text-base font-medium rounded-xl hover:bg-gray-100 transition duration-150">
                            <i data-lucide="truck" class="w-5 h-5 mr-2"></i>
                            Track My Order
                        </a>

                        <a href="{% url 'home' %}" class="w-full sm:w-auto flex items-center justify-center px-6 py-3 bg-indigo-600 text-white text-base font-medium rounded-xl shadow-lg hover:bg-indigo-700 transition duration-150">
                            <i data-lucide="shopping-cart" class="w-5 h-5 mr-2"></i>
                            Continue Shopping
                        </a>
                  </div>
              </div>
          </div>

      </div>

  </div>

</div>


<!-- Script: Slide transition + Payment Method toggle -->
<script>
    // Initialize Lucide icons
    lucide.createIcons();

    // State variable to track the current step
    let currentStep = 1;

    // Step titles for the main heading
    const stepTitles = {
        1: "Your Shopping Cart",
        2: "Secure Checkout",
        3: "Order Complete"
    };

    /**
        * Updates the UI to display the content for the specified step.
        * @param {number} step - The step number (1, 2, or 3).
        */
    function updateUI(step) {
        currentStep = step;
        document.getElementById('main-title').textContent = stepTitles[step];

        // 1. Hide all page content containers
        document.querySelectorAll('.page-content').forEach(content => {
            content.style.display = 'none';
        });

        // 2. Show the current page content
        const currentContent = document.getElementById(`step-${step}-content`);
        if (currentContent) {
            currentContent.style.display = 'block';
        }

        // 3. Update the stepper status
        document.querySelectorAll('.step-item').forEach((item, index) => {
            const stepNum = index + 1;
            const stepNumberEl = item.querySelector('.step-number');
            
            // Get the line element *after* this step (lines 1-2 and 2-3)
            const lineId = `line-${stepNum}-${stepNum + 1}`;
            const lineEl = document.getElementById(lineId); 

            // --- FIX: Robust checks on elements ---
            if (!stepNumberEl) {
                console.error(`Step number element not found for step ${stepNum}`);
                return; 
            }
            
            const checkIcon = stepNumberEl.querySelector('i[data-lucide="check"]');
            const numberSpan = stepNumberEl.querySelector('span');

            // Reset classes
            item.classList.remove('step-active', 'step-complete', 'text-gray-900');
            stepNumberEl.classList.remove('border-black', 'bg-black', 'text-white');
            item.classList.add('text-gray-400'); // Default to inactive text color
            
            if (lineEl) {
                lineEl.classList.remove('step-line-active', 'bg-gray-900');
                lineEl.classList.add('bg-gray-300');
            }

            if (stepNum < step) {
                // Complete step
                item.classList.add('step-complete', 'text-gray-900');
                item.classList.remove('text-gray-400');
                stepNumberEl.classList.add('border-black', 'bg-black', 'text-white');
                
                if (checkIcon) checkIcon.style.display = 'block';
                if (numberSpan) numberSpan.style.display = 'none';
                
                if (lineEl) {
                    lineEl.classList.add('step-line-active', 'bg-gray-900');
                    lineEl.classList.remove('bg-gray-300');
                }
            } else if (stepNum === step) {
                // Active step
                item.classList.add('step-active', 'text-gray-900');
                item.classList.remove('text-gray-400');
                stepNumberEl.classList.add('border-black', 'bg-black', 'text-white');
                
                if (checkIcon) checkIcon.style.display = 'none';
                if (numberSpan) numberSpan.style.display = 'block';

            } else {
                // Future step
                if (checkIcon) checkIcon.style.display = 'none';
                if (numberSpan) numberSpan.style.display = 'block';
            }
        });

        // Re-render Lucide icons if content changed
        lucide.createIcons();
        
        // Step 3 should not be manually clickable after initialization
        const step3Element = document.getElementById('step-3');
        if (step3Element) {
            step3Element.classList.remove('cursor-pointer');
            step3Element.onclick = null;
        }
        
        // Scroll to top for better UX on page change
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    /**
        * Function to go to the next logical step.
        */
    function nextStep() {
        if (currentStep < 3) {
            updateUI(currentStep + 1);
        }
    }

    /**
        * Function to navigate to any previous step.
        * @param {number} step - The step number to go to.
        */
    function goToStep(step) {
        // Allow going back to previous steps (1 or 2)
        if (step >= 1 && step < 3 && step <= currentStep) {
            updateUI(step);
        }
    }

    // Initialize the first view on load
    window.onload = () => {
        updateUI(1);
    };
</script>

<script>
  document.addEventListener('DOMContentLoaded', function(){
        const subtotal = document.getElementById('sub-total');
        const shipping = document.getElementById('shipping');
        const total = document.getElementById('total');

        // Function to extract numeric value from text like "27000.0 tk"
        function extractNumber(text) {
            return parseFloat(text.replace(/[^\d.]/g, ""));
        }

        // Updating cart prod item value and price
        const updatebtn = document.querySelectorAll('.updatebtn')
        let updvalue;
        let debounceTimeout;
        updatebtn.forEach(input=>{
            input.addEventListener('input', function(){
                updvalue = this.value;
                prodId = this.dataset.prodId
                clearTimeout(debounceTimeout);
                debounceTimeout = setTimeout(() => {
                    fetch("{% url 'cart-update' %}", {
                        method: "POST",
                        headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify({prodId: prodId, updval: updvalue})
                    })
                    .then(res=> res.json())
                    .then(data => {
                    document.getElementById('count').innerText= data.cart;
                    subtotal.innerText = data.total+" tk";
                    shipping_cost= extractNumber(shipping.textContent)
                    total.innerText = Number(data.total)+Number(shipping_cost)+" tk";
                });
                    
                }, 1000);
            })
        })


        // deleting cart
        const delBtn = document.querySelectorAll('.delBtn');
        delBtn.forEach(delBtn => {
            delBtn.addEventListener('click', function(){
                prodId = this.dataset.prodId
                prodContainer = this.closest('.product-container')

                fetch("{% url 'cart-delete' %}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({prodId: prodId})
                }).then(res => res.json())
                .then(data => {
                    document.getElementById('count').innerText= data.cart;
                    prodContainer.remove();
                    subtotal.innerText = data.total+" tk";
                    shipping_cost= Number(data.total) === 0 ? (shipping.innerText = "0 tk", 0) : extractNumber(shipping.textContent)
                    total.innerText = Number(data.total)+Number(shipping_cost)+" tk";
                });

                
            })
        })

    })
</script>

{% endblock %}













